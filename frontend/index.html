<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>H12 - Dashboard de Sentimento</title>
        
        <!-- Favicon -->
        <link rel="icon" type="image/png" href="favicon.png">

        <!-- Styles -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
        <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="style.css">
        
        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    
    <body class="mode-analysis" data-sentiment="default">

        <!-- MODAL FOR CHARTS -->
        <div id="chartModal" class="chart-modal" onclick="closeModal(event)">
            
            <div class="chart-modal-content">
                
                <span class="close-modal" onclick="closeModal(event)">&times;</span>
                
                <div style="position: relative; height: 90%; width: 100%;">
                    <canvas id="modalCanvas"></canvas>
                </div>
            
            </div>

        </div>

        <!-- VISUAL ELEMENTS -->
        <div class="particles" id="particles"></div>
        <h1 class="context-title" id="context-title">AN√ÅLISE DE</h1>
        <div class="animated-logo logo-left" id="wordLeft">SENTI</div>
        <div class="animated-logo logo-right" id="wordRight">MENTO</div>

        <header>

            <div class="brand"><i class="fas fa-puzzle-piece"></i> H12 SENTIMENT API</div>
            
            <nav class="nav-tabs">
                <button class="tab-btn active" onclick="switchTab('analysis')">AN√ÅLISE</button>
                <button class="tab-btn" onclick="switchTab('history')">HIST√ìRICO</button>
                <button class="tab-btn" onclick="switchTab('dashboard')">DASHBOARD</button>
            </nav>

        </header>

        <main>
            <!-- TAB 1: ANALYZER -->
            <div id="tab-analysis" class="tab-content" style="display:flex;">

                <div class="analyzer-card">
                    
                    <h2 style="font-family: var(--font-display);">Nova An√°lise</h2>
                    
                    <textarea id="inputText" rows="4" placeholder="O que seu cliente est√° dizendo?"></textarea>
                    
                    <div style="display:flex; justify-content: space-between; align-items: center;">
                        <select id="modelSelect">
                            <option value="nb">Naive Bayes (R√°pido)</option>
                            <option value="svm">SVM (Preciso)</option>
                            <option value="lr">Logistic Regression (M√©dia)</option>
                        </select>
                        <button class="btn-analyze" onclick="analyzeSentiment()">PROCESSAR</button>
                    </div>

                    <div id="resultBox" class="result-box">
                        <div id="resultEmoji" style="font-size: 3rem; margin-bottom: 10px;"></div>
                        <h3 id="resultLabel"></h3>
                        <p id="resultProb" style="color: var(--nc-text-muted);"></p>
                    </div>

                </div>

            </div>

            <!-- TAB 2: HISTORY -->
            <div id="tab-history" class="tab-content">

                <h2 style="margin-bottom: 20px;">Hist√≥rico de An√°lises</h2>

                <div class="table-container" style="overflow-x: auto;">
                    <table id="historyTable">
                        <thead>
                            <tr><th>ID</th><th>Data</th><th>Modelo</th><th>Idioma</th><th>Feedback</th><th>Sentimento</th><th>Confian√ßa</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="pagination-controls" style="text-align: center; margin-top: 20px;">
                    <button id="btn-first-page" class="btn-analyze" disabled>Primeira</button>
                    <button id="btn-prev-page" class="btn-analyze" disabled>Anterior</button>
                    <span id="page-info" style="color: var(--nc-text-muted); margin: 0 10px;">P√°gina 0 de 0</span>
                    <button id="btn-next-page" class="btn-analyze" disabled>Pr√≥ximo</button>
                    <button id="btn-last-page" class="btn-analyze" disabled>√öltima</button>
                </div>

            </div>

            <!-- TAB 3: DASHBOARD -->
            <div id="tab-dashboard" class="tab-content">

                <div class="kpi-row">
                    <div class="kpi-card"><div class="kpi-label">Total</div><div class="kpi-value" id="kpiTotal">0</div></div>
                    <div class="kpi-card"><div class="kpi-label">ROI Est.</div><div class="kpi-value" id="kpiRoi" style="color: #00e676;">R$ 0,00</div></div>
                    <div class="kpi-card"><div class="kpi-label">Positividade</div><div class="kpi-value" id="kpiPositivity">0%</div></div>
                </div>

                <div class="chart-grid-enhanced">
                    <!-- 1. Distribution (Pie) -->
                    <div class="mini-chart-card" onclick="openChartModal('dist')">
                        <h4>Distribui√ß√£o Geral <i class="fas fa-expand-alt"></i></h4>
                        <div style="height: 220px; position: relative;"><canvas id="chartDistMini"></canvas></div>
                    </div>
                    <!-- 2. Timeline (Line) -->
                    <div class="mini-chart-card" onclick="openChartModal('time')">
                        <h4>Evolu√ß√£o Temporal <i class="fas fa-expand-alt"></i></h4>
                        <div style="height: 220px; position: relative;"><canvas id="chartTimeMini"></canvas></div>
                    </div>
                    <!-- 3. Models Usage (Bar) -->
                    <div class="mini-chart-card" onclick="openChartModal('models')">
                        <h4>Uso de Modelos <i class="fas fa-expand-alt"></i></h4>
                        <div style="height: 220px; position: relative;"><canvas id="chartModelsMini"></canvas></div>
                    </div>
                    <!-- 4. Language Confidence (Radar) -->
                    <div class="mini-chart-card" onclick="openChartModal('radar')">
                        <h4>Confian√ßa M√©dia <i class="fas fa-expand-alt"></i></h4>
                        <div style="height: 220px; position: relative;"><canvas id="chartRadarMini"></canvas></div>
                    </div>
                    <!-- 5. Languages (Pie) -->
                    <div class="mini-chart-card" onclick="openChartModal('langs')">
                        <h4>Idiomas Processados <i class="fas fa-expand-alt"></i></h4>
                        <div style="height: 220px; position: relative;"><canvas id="chartLangsMini"></canvas></div>
                    </div>
                    <!-- 6. Sentiment by Model (Stacked Bar) -->
                    <div class="mini-chart-card" onclick="openChartModal('sentModel')">
                        <h4>Sentimento por Modelo <i class="fas fa-expand-alt"></i></h4>
                        <div style="height: 220px; position: relative;"><canvas id="chartSentModelMini"></canvas></div>
                    </div>
                    <!-- 7. Hourly Peak (Bar) -->
                    <div class="mini-chart-card" onclick="openChartModal('hourly')">
                        <h4>Hor√°rios de Pico <i class="fas fa-expand-alt"></i></h4>
                        <div style="height: 220px; position: relative;"><canvas id="chartHourlyMini"></canvas></div>
                    </div>
                    <!-- 8. Confidence Levels (Doughnut/Gauge) -->
                    <div class="mini-chart-card" onclick="openChartModal('conf')">
                        <h4>N√≠veis de Certeza <i class="fas fa-expand-alt"></i></h4>
                        <div style="height: 220px; position: relative;"><canvas id="chartConfMini"></canvas></div>
                    </div>
                    <!-- 9. Feedback Length (Horizontal Bar) -->
                    <div class="mini-chart-card" onclick="openChartModal('len')">
                        <h4>Tamanho do Feedback <i class="fas fa-expand-alt"></i></h4>
                        <div style="height: 220px; position: relative;"><canvas id="chartLenMini"></canvas></div>
                    </div>
                </div>

            </div>

        </main>

        <script>
            const API_URL = 'http://localhost:8080/sentiment';
            
            let currentPage = 0;
            let totalPages = 0;
            let charts = { 
                dist: null, time: null, models: null, radar: null,
                langs: null, sentModel: null, hourly: null, conf: null, len: null 
            };
            let modalChart = null;

            const visualMap = {
                'positive': { wordL: 'POSI', wordR: 'TIVO', color: 'positive', icon: 'üòç' },
                'negative': { wordL: 'NEGA', wordR: 'TIVO', color: 'negative', icon: 'üò°' },
                'neutral':  { wordL: 'NEU', wordR: 'TRO',  color: 'neutral',  icon: 'üòê' },
                'positivo': { wordL: 'POSI', wordR: 'TIVO', color: 'positive', icon: 'üòç' },
                'negativo': { wordL: 'NEGA', wordR: 'TIVO', color: 'negative', icon: 'üò°' },
                'neutro':   { wordL: 'NEU', wordR: 'TRO',  color: 'neutral',  icon: 'üòê' },
                'default':  { wordL: 'SENTI', wordR: 'MENTO', color: 'default', icon: '' }
            };

            // --- CORE FUNCTIONS ---

            function resetAnalysisState() {
                document.getElementById('inputText').value = '';
                document.getElementById('resultBox').style.display = 'none';
                document.body.setAttribute('data-sentiment', 'default');
                document.getElementById('wordLeft').innerText = 'SENTI';
                document.getElementById('wordRight').innerText = 'MENTO';
                document.body.style.backgroundColor = 'var(--nc-bg-dark)';
            }

            function switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                
                const activeDiv = document.getElementById(`tab-${tabName}`);
                
                if(tabName === 'analysis') {
                    activeDiv.style.display = 'flex';
                    document.body.classList.add('mode-analysis');
                } else {
                    activeDiv.style.display = 'block';
                    document.body.classList.remove('mode-analysis');
                    document.body.style.backgroundColor = 'var(--nc-bg-dark)';
                    resetAnalysisState();
                    
                    if(tabName === 'history') loadHistoryData(0);
                    if(tabName === 'dashboard') updateDashboard();
                }
                
                event.currentTarget.classList.add('active');
            }

            document.getElementById('inputText').addEventListener('input', (e) => {
                if(e.target.value.trim() === '') {
                    resetAnalysisState();
                }
            });

            async function analyzeSentiment() {
                const text = document.getElementById('inputText').value;
                const model = document.getElementById('modelSelect').value;
                if(!text.trim()) return;

                const btn = document.querySelector('.btn-analyze');
                btn.disabled = true; btn.innerText = '...';

                try {
                    const res = await fetch(`${API_URL}/predict`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, algorithm: model })
                    });

                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

                    const data = await res.json();
                    applyVisuals((data.previsao || '').trim().toLowerCase(), data.probabilidade);
                } catch (err) { 
                    console.error("Fetch Error:", err);
                    alert('Erro na conex√£o com a API.'); 
                }
                finally { btn.disabled = false; btn.innerText = 'PROCESSAR'; }
            }

            function applyVisuals(sentiment, prob) {
                const config = visualMap[sentiment] || visualMap['default'];
                document.body.setAttribute('data-sentiment', config.color);
                document.getElementById('wordLeft').innerText = config.wordL;
                document.getElementById('wordRight').innerText = config.wordR;
                const box = document.getElementById('resultBox');
                box.style.display = 'block';
                document.getElementById('resultEmoji').innerText = config.icon;
                document.getElementById('resultLabel').innerText = sentiment.toUpperCase();
                document.getElementById('resultProb').innerText = `Confian√ßa: ${(prob*100).toFixed(1)}%`;
            }

            async function loadHistoryData(page = 0) {
                const size = 10;
                try {
                    const res = await fetch(`${API_URL}/history?page=${page}&size=${size}&sort=createdAt,desc`);
                    const data = await res.json();
                    
                    currentPage = data.number;
                    totalPages = data.totalPages;

                    const tbody = document.querySelector('#historyTable tbody');
                    tbody.innerHTML = '';
                    
                    data.content.forEach(item => {
                        const tr = document.createElement('tr');
                        let pred = (item.prediction || '').trim().toLowerCase();
                        let pill = ['positive', 'positivo'].includes(pred) ? 'pill-pos' : (['negative', 'negativo'].includes(pred) ? 'pill-neg' : '');
                        const dateStr = new Date(item.createdAt).toLocaleDateString('pt-BR');
                        tr.innerHTML = `<td>#${item.id}</td><td>${dateStr}</td><td>${item.modelType}</td><td>${item.language || 'N/A'}</td><td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.originalText}</td><td><span class="pill ${pill}">${item.prediction}</span></td><td>${(item.probability*100).toFixed(0)}%</td>`;
                        tbody.appendChild(tr);
                    });

                    document.getElementById('btn-first-page').disabled = data.first;
                    document.getElementById('btn-prev-page').disabled = data.first;
                    document.getElementById('btn-next-page').disabled = data.last;
                    document.getElementById('btn-last-page').disabled = data.last;
                    document.getElementById('page-info').innerText = `P√°gina ${currentPage + 1} de ${totalPages}`;
                } catch(e) {
                    console.error("Failed to load history:", e);
                }
            }
            
            document.getElementById('btn-first-page').addEventListener('click', () => loadHistoryData(0));
            document.getElementById('btn-prev-page').addEventListener('click', () => loadHistoryData(currentPage - 1));
            document.getElementById('btn-next-page').addEventListener('click', () => loadHistoryData(currentPage + 1));
            document.getElementById('btn-last-page').addEventListener('click', () => loadHistoryData(totalPages - 1));

            async function updateDashboard() {
                try {
                    const endpoints = [
                        'kpis', 'distribution', 'models', 'languages', 'hourly-peak',
                        'sentiment-by-model', 'confidence-levels', 'feedback-length',
                        'timeline', 'average-confidence'
                    ];
                    const promises = endpoints.map(e => fetch(`${API_URL}/analytics/${e}`));
                    const responses = await Promise.all(promises);
                    const jsonData = await Promise.all(responses.map(res => res.json()));

                    const analyticsData = endpoints.reduce((acc, name, index) => {
                        acc[name] = jsonData[index];
                        return acc;
                    }, {});

                    // 1. KPIs
                    document.getElementById('kpiTotal').innerText = analyticsData.kpis.totalAnalyses;
                    document.getElementById('kpiRoi').innerText = `R$ ${(analyticsData.kpis.totalAnalyses*2.5).toFixed(2)}`;
                    document.getElementById('kpiPositivity').innerText = `${analyticsData.kpis.positivityPercentage.toFixed(0)}%`;

                    // 2. Distribution
                    const distData = {
                        labels: Object.keys(analyticsData.distribution.distribution),
                        datasets: [{ 
                            data: Object.values(analyticsData.distribution.distribution),
                            backgroundColor: ['#28a745', '#dc3545', '#6c757d'], 
                            borderColor: '#1e1e2f' 
                        }]
                    };
                    renderMiniChart('dist', 'chartDistMini', 'doughnut', distData);

                    // 3. Models Usage
                    const modelData = {
                        labels: Object.keys(analyticsData.models.usage),
                        datasets: [{ 
                            label: 'An√°lises', 
                            data: Object.values(analyticsData.models.usage),
                            backgroundColor: ['#9F4BBA', '#F90399', '#2E9EE0'] 
                        }]
                    };
                    renderMiniChart('models', 'chartModelsMini', 'bar', modelData);
                    
                    // 4. Languages
                    const langData = {
                        labels: analyticsData.languages.labels,
                        datasets: [{ data: analyticsData.languages.values, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'] }]
                    };
                    renderMiniChart('langs', 'chartLangsMini', 'pie', langData);

                    // 5. Hourly Peak
                    const hourlyData = {
                        labels: analyticsData['hourly-peak'].labels,
                        datasets: [{ label: 'Volume', data: analyticsData['hourly-peak'].values, backgroundColor: '#2E9EE0' }]
                    };
                    renderMiniChart('hourly', 'chartHourlyMini', 'bar', hourlyData);

                    // 6. Sentiment by Model
                    const sentModelData = {
                        labels: analyticsData['sentiment-by-model'].labels,
                        datasets: analyticsData['sentiment-by-model'].datasets.map(d => ({...d, backgroundColor: d.label === 'Positivo' ? '#28a745' : d.label === 'Negativo' ? '#dc3545' : '#6c757d'}))
                    };
                    renderMiniChart('sentModel', 'chartSentModelMini', 'bar', sentModelData, { scales: { x: { stacked: true }, y: { stacked: true } } });

                    // 7. Confidence Levels
                    const confData = {
                        labels: analyticsData['confidence-levels'].labels,
                        datasets: [{ data: analyticsData['confidence-levels'].values, backgroundColor: ['#00e676', '#ffb74d'], borderWidth: 0 }]
                    };
                    renderMiniChart('conf', 'chartConfMini', 'doughnut', confData);

                    // 8. Feedback Length
                    const lenData = {
                        labels: analyticsData['feedback-length'].labels,
                        datasets: [{ label: 'Volume', data: analyticsData['feedback-length'].values, backgroundColor: ['#4BC0C0', '#FFCE56', '#FF6384'], indexAxis: 'y' }]
                    };
                    renderMiniChart('len', 'chartLenMini', 'bar', lenData, { indexAxis: 'y' });

                    // 9. Timeline
                    const timeData = {
                        labels: analyticsData.timeline.labels,
                        datasets: [{ label: 'Volume', data: analyticsData.timeline.values, borderColor: '#2E9EE0', backgroundColor: 'rgba(46,158,224,0.2)', fill: true, tension: 0.4 }]
                    };
                    renderMiniChart('time', 'chartTimeMini', 'line', timeData);

                    // 10. Radar
                    const radarData = {
                        labels: analyticsData['average-confidence'].labels,
                        datasets: [{ 
                            label: 'Confian√ßa M√©dia (%)', 
                            data: analyticsData['average-confidence'].values, 
                            backgroundColor: analyticsData['average-confidence'].labels.map(label => {
                                if (label.toLowerCase().includes('positivo')) return '#2ecc71';
                                if (label.toLowerCase().includes('negativo')) return '#e74c3c';
                                return '#F90399'; // Default or other sentiments
                            }),
                            barPercentage: 0.6,
                            borderWidth: 0
                        }]
                    };
                    renderMiniChart('radar', 'chartRadarMini', 'bar', radarData, {indexAxis: 'y',scales:{x:{min:0,max:100,ticks:{stepSize:25}}}});

                } catch(e) {
                    console.error("Failed to update dashboard with analytics data:", e);
                }
            }

            function renderMiniChart(key, canvasId, type, data, extraOptions = {}) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if(charts[key]) charts[key].destroy();
                
                const defaultOptions = {
                    indexAxis: extraOptions.indexAxis || 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: (type === 'radar' || type === 'doughnut' || type === 'pie') ? {} : {
                        x: { ticks: { display: false }, grid: { display: false }, ...extraOptions?.scales?.x },
                        y: { ticks: { display: false }, grid: { display: false }, ...extraOptions?.scales?.y }
                    }
                };

                charts[key] = new Chart(ctx, { type: type, data: data, options: defaultOptions });
                charts[key].fullData = data;
                charts[key].chartType = type;
                charts[key].extraOptions = extraOptions;
            }

            function openChartModal(key) {
                const modal = document.getElementById('chartModal');
                const canvas = document.getElementById('modalCanvas');
                const sourceChart = charts[key];
                if(!sourceChart) return;

                modal.style.display = 'flex';
                if(modalChart) modalChart.destroy();

                const chartData = JSON.parse(JSON.stringify(sourceChart.fullData));
                const ctx = canvas.getContext('2d');
                
                const titles = {
                    dist: 'Distribui√ß√£o Geral de Sentimentos', time: 'Evolu√ß√£o Temporal do Volume de Feedbacks',
                    models: 'Comparativo de Uso dos Modelos de IA', radar: '√çndice de Confian√ßa M√©dia por Categoria',
                    langs: 'Distribui√ß√£o por Idioma Detectado', sentModel: 'An√°lise de Sentimento por Algoritmo',
                    hourly: 'Volume de An√°lises por Hor√°rio do Dia', conf: 'Propor√ß√£o de N√≠veis de Certeza (High vs Low)',
                    len: 'Distribui√ß√£o por Tamanho do Texto (Caracteres)'
                };

                let modalScales = {};
                if (sourceChart.chartType === 'bar' || sourceChart.chartType === 'line') {
                    modalScales = {
                        x: { title: { display: true, text: (key === 'hourly' ? 'Hora do Dia' : 'Per√≠odo'), color: '#aaa' }, ticks: { color: '#ddd' }, grid: { color: 'rgba(255,255,255,0.1)' }, ...sourceChart.extraOptions?.scales?.x },
                        y: { title: { display: true, text: 'Qtd. de An√°lises', color: '#aaa' }, ticks: { color: '#ddd' }, grid: { color: 'rgba(255,255,255,0.1)' }, ...sourceChart.extraOptions?.scales?.y }
                    };
                } else if (sourceChart.chartType === 'radar') {
                    modalScales = { r: { min: 0, max: 100, ticks: { backdropColor: 'transparent', color: '#fff', stepSize: 20 }, grid: { color: 'rgba(255,255,255,0.2)' }, pointLabels: { color: '#fff', font: { size: 14 } }, angleLines: { color: 'rgba(255,255,255,0.1)' } } };
                }

                const modalOptions = {
                    indexAxis: sourceChart.extraOptions?.indexAxis || 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: true, labels: { color: '#fff', font: { size: 14 } } },
                        title: { display: true, text: titles[key] || 'Visualiza√ß√£o Detalhada', color: '#fff', font: { size: 20 } }
                    },
                    scales: modalScales
                };

                setTimeout(() => { modalChart = new Chart(ctx, { type: sourceChart.chartType, data: chartData, options: modalOptions }); }, 50);
            }

            function closeModal(e) {
                if (e.target.id === 'chartModal' || e.target.classList.contains('close-modal')) {
                    const modal = document.getElementById('chartModal');
                    modal.style.display = 'none';
                    if(modalChart) { modalChart.destroy(); modalChart = null; }
                }
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('chartModal');
                    if (modal.style.display === 'flex') closeModal({target: modal});
                }
            });

            // INIT PARTICLES
            const container = document.getElementById('particles');
            for(let i=0; i<50; i++) {
                const p = document.createElement('i');
                p.className = 'fas fa-puzzle-piece particle';
                p.style.left = Math.random()*100+'%';
                p.style.animationDuration = (Math.random()*3+3)+'s';
                p.style.animationDelay = Math.random()*5+'s';
                container.appendChild(p);
            }
        </script>

    </body>

</html>